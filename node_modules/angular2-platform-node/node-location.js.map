{"version":3,"file":"node-location.js","sourceRoot":"","sources":["../../../../modules/platform-node/node-location.ts"],"names":[],"mappings":"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","sourcesContent":["import { Injectable, Inject, Optional } from '@angular/core';\nimport { PlatformLocation, APP_BASE_HREF } from '@angular/common';\n\nimport { REQUEST_URL, ORIGIN_URL } from './tokens';\n\nimport * as nodeUrl from 'url';\n\nexport interface LocationConfig {\n  pathname?: string;\n  search?: string;\n  hash?: string;\n}\n\nexport interface NodeLocationConfig {\n  hash?: string;\n  host?: string;\n  hostname?: string;\n  href?: string;\n  pathname?: string;\n  port?: string;\n  protocol?: string;\n  search?: string;\n}\n\nexport class NodeLocation implements LocationConfig {\n  hash: string;\n  host: string;\n  hostname: string;\n  href: string;\n  pathname: string;\n  port: string;\n  protocol: string;\n  search: string;\n  get origin(): string {\n    return this.protocol + '//' + this.hostname + ':' + this.port;\n  }\n  constructor(config: NodeLocationConfig & LocationConfig) {\n    this.assign(config);\n  }\n  parse(url: string) {\n    return nodeUrl.parse(url);\n  }\n  format(obj: NodeLocationConfig): string {\n    return nodeUrl.format(obj);\n  }\n  assign(parsed: NodeLocationConfig): this {\n    this.pathname = parsed.pathname || '';\n    this.search = parsed.search || '';\n    this.hash = parsed.hash || '';\n    this.host = parsed.host;\n    this.hostname = parsed.hostname;\n    this.href = parsed.href;\n    this.port = parsed.port;\n    this.protocol = parsed.protocol;\n    return this;\n  }\n  toJSON(): NodeLocationConfig {\n    let config: NodeLocationConfig = {\n      hash: this.hash,\n      host: this.host,\n      hostname: this.hostname,\n      href: this.href,\n      pathname: this.pathname,\n      port: this.port,\n      protocol: this.protocol,\n      search: this.search\n    };\n    return config;\n  }\n\n}\n\nexport class State {\n  constructor(\n    public state: any,\n    public title: string,\n    public url: string) {}\n\n  toJSON() {\n    return {\n      state: this.state,\n      title: this.title,\n      url: this.url\n    };\n  }\n}\n\nexport class PopStateEvent {\n  public type = 'popstate';\n  constructor(public state: any) {}\n\n  toJSON() {\n    return {\n      state: this.state\n    };\n  }\n\n}\n\n\nexport class NodePlatformLocation extends PlatformLocation {\n  private _loc: LocationConfig;\n  private _stack: Array<State> = [];\n  private _stackIndex = -1;\n  private _popStateListeners: Array<Function> = [];\n  private _baseUrl: string = '/';\n  private _originUrl: string;\n\n  constructor(\n      originUrl: string,\n      requestUrl: string,\n      baseUrl?: string) {\n    super();\n    this._originUrl = originUrl;\n    this._baseUrl = baseUrl || '/';\n    // this.pushState(null, null, joinWithSlash(this._baseUrl, requestUrl));\n    this.pushState(null, null, requestUrl);\n  }\n  updateUrl(originUrl, baseUrl = '/') {\n    this._originUrl = originUrl;\n    this._baseUrl = baseUrl || '/';\n  }\n\n  get search(): string { return this._loc.search; }\n  get hash(): string { return this._loc.hash; }\n  get pathname(): string { return this._loc.pathname; }\n  set pathname(newPathname: string) { this._loc.pathname = newPathname; }\n\n  getBaseHrefFromDOM(): string {\n    throw new Error(`\n      Attempt to get base href from DOM on the server.\n      You have to provide a value for the APP_BASE_HREF token through DI.\n    `);\n  }\n\n  getBaseHref(): string { return this._baseUrl; }\n\n  path(): string { return this._loc.pathname; }\n\n  pushState(state: any, title: string, url: string): void {\n    this._stack.push(new State(state, title, url));\n    this._stackIndex++;\n    this._updateLocation();\n  }\n\n  replaceState(state: any, title: string, url: string): void {\n    this._stack[this._stackIndex] = new State(state, title, url);\n    this._updateLocation();\n  }\n\n  onPopState(fn): void { this._popStateListeners.push(fn); }\n  onHashChange(_fn): void { /*TODO*/}\n\n  back(): void {\n    if (this._stackIndex === 0) {\n      return;\n    }\n\n    this._stackIndex--;\n    this._updateLocation();\n    this._callPopStateListeners();\n  }\n\n  forward(): void {\n    if (this._stackIndex === this._stack.length - 1) {\n      return;\n    }\n\n    this._stackIndex++;\n    this._updateLocation();\n    this._callPopStateListeners();\n  }\n\n  prepareExternalUrl(internal: string): string {\n    return joinWithSlash(this._baseUrl, internal);\n  }\n\n  toJSON(): any {\n    return {\n      location: this._loc,\n      stack: this._stack,\n      stackIndex: this._stackIndex,\n      popStateListeners: this._popStateListeners,\n      baseHref: this._baseUrl\n    };\n  }\n\n  private _updateLocation(): void {\n    const state: State = this._stack[this._stackIndex];\n    const url: string = state.url;\n\n    this._setLocationByUrl(url);\n  }\n\n  private _setLocationByUrl(url: string): void {\n    const resolvedOriginBase = nodeUrl.resolve(this._originUrl, this._baseUrl);\n    const resolvedWithUrl = nodeUrl.resolve(resolvedOriginBase, url);\n    const nodeLocation: NodeLocationConfig = nodeUrl.parse(resolvedWithUrl);\n    this._loc = new NodeLocation(nodeLocation);\n  }\n\n  private _callPopStateListeners() {\n    const state = this._stack[this._stackIndex].state;\n    const event = new PopStateEvent(state);\n\n    // Actually listeners should be called asynchronously,\n    // But right now I don't know what is better for a server side.\n    this._popStateListeners.forEach(listener => listener(event));\n  }\nstatic decorators: DecoratorInvocation[] = [\n{ type: Injectable },\n];\n/** @nocollapse */\nstatic ctorParameters: ({type: any, decorators?: DecoratorInvocation[]}|null)[] = [\n{type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [ORIGIN_URL, ] }, ]},\n{type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [REQUEST_URL, ] }, ]},\n{type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [APP_BASE_HREF, ] }, ]},\n];\n}\n\n// @internal\nexport function joinWithSlash(start: string, end: string): string {\n  if (start.length === 0) {\n    return end;\n  }\n  if (end.length === 0) {\n    return start;\n  }\n  var slashes = 0;\n  if ((<any>start).endsWith('/')) {\n    slashes++;\n  }\n  if ((<any>end).startsWith('/')) {\n    slashes++;\n  }\n  if (slashes === 2) {\n    return start + end.substring(1);\n  }\n  if (slashes === 1) {\n    return start + end;\n  }\n  return start + '/' + end;\n}\n\nexport const NODE_LOCATION_PROVIDERS: Array<any> = [\n  // NodePlatformLocation,\n  { provide: PlatformLocation, useClass: NodePlatformLocation }\n];\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}